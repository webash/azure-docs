---
title: Store Vulnerability Assessment scan results in a storage account accessible behind firewalls and VNets
description: "Provides instructions on how to store Vulnerability Assessment (VA) scans in a storage account that can be accessed through a firewall or a VNet"
services: sql-database
ms.service: sql-db-mi
ms.subservice: security
ms.topic: how-to
author: davidtrigano
ms.author: datrigan
ms.reviewer: vanto
ms.date: 12/01/2020
---

# Store Vulnerability Assessment scan results in a storage account accessible behind firewalls and VNets
[!INCLUDE[appliesto-sqldb-sqlmi-asa](../includes/appliesto-sqldb-sqlmi-asa.md)]

If you are limiting access to your storage account in Azure for certain VNets or services, you'll need to enable the appropriate configuration so that Vulnerability Assessment (VA) scanning for SQL Databases or Managed Instances have access to that storage account.

## Prerequisites

The SQL Vulnerability Assessment service needs permission to the storage account to save baseline and scan results.  There are three methods: 
- **Use Storage Account key**: Azure creates the SAS key and saves it (though we don't save the account key)
- **Use Storage SAS key**: The SAS key must have: Write | List | Read | Delete permissions
- **Use SQL Server managed identity**: The SQL Server must have a managed identity. The storage account must have a role assignment for the SQL Managed Identity as StorageBlobContributor. When you apply the settings, the VA fields storageContainerSasKey and storageAccountAccessKey must be empty. When storage is behind a firewall or  virtual network, then the SQL managed identity is required. 

When you use the Azure portal to save SQL VA settings, Azure checks if you have permission to assign a new role assignment for the managed identity as StorageBlobContributor on the storage. If permissions are assigned, Azure uses SQL Server managed identity, otherwise Azure uses the key method. 

## Enable Azure SQL Database VA scanning access to the storage account

If you have configured your VA storage account to only be accessible by certain networks or services, you'll need to ensure that VA scans for your Azure SQL Database are able to store the scans on the storage account. You can use the existing storage account, or create a new storage account to store VA scan results for all databases on your [logical SQL server](logical-servers.md).

> [!NOTE]
> The vulnerability assessment service can't access storage accounts protected with firewalls or VNets if they require storage access keys.

Go to your **Resource group** that contains the storage account and access the **Storage account** pane. Under **Settings**, select **Firewall and virtual networks**.

Ensure that **Allow trusted Microsoft services access to this storage account** is checked.

:::image type="content" source="media/sql-database-vulnerability-assessment-storage/storage-allow-microsoft-services.png" alt-text="Screenshot shows Firewall and virtual networks dialog box, with Allow trusted Microsoft services to access this storage account selected.":::

To find out which storage account is being used, go to your **SQL server** pane in the [Azure portal](https://portal.azure.com), under **Security**, select **Security Center**.

:::image type="content" source="../database/media/azure-defender-for-sql/va-storage.png" alt-text="set up vulnerability assessment":::

> [!NOTE]
> You can set up email alerts to notify users in your organization to view or access the scan reports. To do this, ensure that you have SQL Security Manager and Storage Blob Data Reader permissions.

## Store VA scan results for Azure SQL Managed Instance in a storage account that can be accessed behind a firewall or VNet

Since Managed Instance is not a trusted Microsoft Service and has a different VNet from the storage account, executing a VA scan will result in an error.

To support VA scans on Managed Instances, follow the below steps:

1. In the **SQL managed instance** pane, under the **Overview** heading, click the **Virtual network/subnet** link. This takes you to the **Virtual network** pane.

   :::image type="content" source="../managed-instance/media/public-endpoint-configure/mi-overview.png" alt-text="mi-overview2":::

1. Under **Settings**, select **Subnets**. Click **Subnet** in the new pane to add a subnet, and delegate it to *Microsoft.Sql\managedInstance*. For more information, see [Manage subnets](../../virtual-network/virtual-network-manage-subnet.md).

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/mi-subnets.png" alt-text="Screenshot shows a subnet that has been delegated Microsoft.sql\managedInstance.":::

1. In your **Virtual network** pane, under **Settings**, select **Service endpoints**. Click **Add** in the new pane, and add the *Microsoft.Storage* Service as a new service endpoint. Make sure the *ManagedInstance* Subnet is selected. Click **Add**.

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/mi-service-endpoint.png" alt-text="Screenshot shows Add service endpoints, where you add the Microsoft.Storage Service as an endpoint.":::

1. Go to your **Storage account** that you've selected to store your VA scans. Under **Settings**, select **Firewall and virtual networks**. Click on **Add existing virtual network**. Select your managed instance virtual network and subnet, and click **Add**.

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/storage-firewall.png" alt-text="Screenshot shows the Firewalls and virtual networks pane, which contains the Add existing virtual network link.":::

You should now be able to store your VA scans for Managed Instances in your storage account.

## Troubleshoot vulnerability assessment scan-related issues 

Troubleshoot common issues related to vulnerability assessment scans.

### Failure to save vulnerability assessment settings

You might not be able to save changes to vulnerability assessment settings if your storage account doesn't meet some prerequisites or if you have insufficient permissions.

#### Storage account requirements

The storage account in which vulnerability assessment scan results are saved must meet the following requirements:

- **Type**: StorageV2 (General Purpose V2) or Storage (General Purpose V1)
- **Performance**: Standard (only)
- **Region**: The storage must be in the same region as the instance of Azure SQL Server.

If any of these requirements aren't met, saving changes to vulnerability assessment settings fails.

#### Permissions 

The following permissions are required to save changes to vulnerability assessment settings:

- SQL Security Manager
- Storage Blob Data Reader

Setting a new role assignment requires owner or user administrator access to the storage account and the following permissions:

- Storage Blob Data Owner

### Storage account isn't visible for selection in vulnerability assessment settings

The storage account might not appear in the storage account picker for several reasons:

- The storage account you're looking for isn't in the selected subscription.
- The storage account you're looking for isn't in the same region as the instance of Azure SQL Server.
- You don't have Microsoft.Storage/storageAccounts/read permissions on the storage account.

### Failure to open an email link for scan results or can't view scan results

You might not be able to open a link in a notification email about scan results or to view scan results if you don't have the required permissions or if you use a browser that doesn't support opening or displaying scan results.

#### Permissions

The following permissions are required to open links in email notifications about scan results or to view scan results:

- SQL Security Manager
- Storage Blob Data Reader

#### Browser requirements

The Firefox browser doesn't support opening or displaying scan results view. We recommend that you use Chrome or Microsoft Edge to view vulnerability assessment scan results.

## Next steps

- [Vulnerability Assessment](sql-vulnerability-assessment.md)
- [Create an Azure Storage account](../../storage/common/storage-account-create.md)
- [Azure Defender for SQL](azure-defender-for-sql.md)
